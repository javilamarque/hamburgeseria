{{>header}}

<div class="container">
    <h1 class="mt-5 text-center">Crear Combo</h1>

    <div class="mt-3">
        <input type="text" id="nombre-combo" class="form-control mx-auto" style="max-width: 300px;"
            placeholder="INGRESE NOMBRE DEL COMBO" required>
    </div>

    <div id="items-section" class="mt-3 text-center d-none">
        <!-- Contenedor dinámico para productos -->
        <div id="productos-container"></div>
        <button type="button" id="agregar-producto-btn" class="btn btn-secondary mt-2">Agregar Producto</button>
    </div>

    <div id="precio-section" class="mt-3 text-center d-none">
        <div class="row justify-content-center">
            <div class="col-md-4 mb-2">
                <input type="text" id="codigo-barra-combo" class="form-control" placeholder="Código de Barra combo"
                    required>
            </div>
            <div class="col-md-4">
                <input type="number" id="precio-combo" class="form-control" placeholder="Precio del Combo" required>
            </div>
        </div>
    </div>

    <div class="mt-4 mb-3 text-center">
        <button id="cancelar-btn" class="btn btn-danger"> <img src="/icons/cancelar.png" alt=""> Cancelar</button>
        <button id="agregar-items-btn" class="btn btn-success ms-2">Agregar Items</button>
        <button id="guardar-btn" class="btn btn-primary ms-2"> <img src="/icons/guardar-el-archivo.png" alt=""> Guardar</button>
    </div>
</div>

<!-- Modal para seleccionar productos -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">Seleccionar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Código de Barras</th>
                            <th>Descripción</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Seleccionar</th>
                        </tr>
                    </thead>
                    <tbody id="productList">
                        <!-- Aquí se cargarán los productos -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Contenedor para mostrar los combos existentes -->
<div id="combos-container" class="container mt-5">
    <!-- Aquí se mostrarán los combos y sus productos -->
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.3/js/bootstrap.min.js"></script>

<script>
    $(document).ready(function () {
        // Mostrar secciones de items y precio al hacer clic en "Agregar Items"
        $('#agregar-items-btn').click(function () {
            $('#items-section').removeClass('d-none');
            $('#precio-section').removeClass('d-none');
        });

        // Funcionalidad del botón "Cancelar"
        $('#cancelar-btn').click(function () {
            window.location.href = '/admin/home';
        });

        // Añadir nuevo campo de producto
        $('#agregar-producto-btn').click(function () {
            const productoRow = `
                <div class="row justify-content-center align-items-center mt-2 producto-row">
                    <div class="col-md-2">
                        <input type="text" class="form-control mb-2 cod_barra" placeholder="Código de barras" readonly>
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control mb-2 producto-seleccionado" placeholder="Seleccione un producto" readonly>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-primary seleccionar-producto-btn mb-2 w-100">Seleccionar Producto</button>
                    </div>
                </div>
            `;
            $('#productos-container').append(productoRow);
        });

        // Abrir el modal de selección de producto al hacer clic en el botón "Seleccionar Producto"
        $(document).on('click', '.seleccionar-producto-btn', function () {
            const productoInput = $(this).closest('.producto-row');
            $('#productModal').data('productoInput', productoInput);
            $.get('/sales/products', function (products) {
                $('#productList').empty();
                products.forEach(function (product) {
                    let row = `
                        <tr>
                            <td>${product.cod_barra}</td>
                            <td>${product.descripcion}</td>
                            <td>${product.precio_venta}</td>
                            <td>${product.stock}</td>
                            <td>
                                <button type="button" class="btn btn-primary seleccionar-producto" 
                                    data-cod_barra="${product.cod_barra}" 
                                    data-descripcion="${product.descripcion}" 
                                    data-precio="${product.precio_venta}">
                                    Seleccionar
                                </button>
                            </td>
                        </tr>
                    `;
                    $('#productList').append(row);
                });
                $('#productModal').modal('show');
            }).fail(function () {
                alert('Error al cargar los productos');
            });
        });

        // Seleccionar un producto del modal
        $(document).on('click', '.seleccionar-producto', function () {
            const productoRow = $('#productModal').data('productoInput');
            let codigoBarraProducto = $(this).data('cod_barra');
            let descripcionProducto = $(this).data('descripcion');

            // Asignar la descripción del producto seleccionado al input correspondiente
            productoRow.find('.producto-seleccionado').val(descripcionProducto);
            // Asignar el código de barras del producto seleccionado al input correspondiente
            productoRow.find('.cod_barra').val(codigoBarraProducto);

            $('#productModal').modal('hide');
        });

        // Transformar los productos a un formato correcto antes de enviar la solicitud
        $('#guardar-btn').click(function () {
            const nombreCombo = $('#nombre-combo').val();
            const codigoBarraCombo = $('#codigo-barra-combo').val();
            const precioCombo = $('#precio-combo').val();
            const productos = [];

            $('.producto-seleccionado').each(function () {
                if ($(this).val() !== '') {
                    productos.push({
                        descripcion: $(this).val(),
                        codigoBarra: $(this).closest('.row').find('.cod_barra').val() // Mantener como cadena de texto
                        //codigoBarra: Number($(this).closest('.row').find('.cod_barra').val()) // Convertir a número
                    });
                }
            });

            if (!nombreCombo || !codigoBarraCombo || !precioCombo || productos.length === 0) {
                alert('Por favor complete todos los campos.');
                return;
            }

            const comboData = {
                nombre: nombreCombo,
                codigoBarra: codigoBarraCombo,
                precio: precioCombo,
                productos: productos
            };

            $.ajax({
                type: 'POST',
                url: '/combos',
                data: JSON.stringify(comboData),
                contentType: 'application/json',
                success: function (response) {
                    alert('Combo guardado exitosamente');
                    window.location.href = '/viewCombo';
                },
                error: function (error) {
                    alert('Error al guardar el combo');
                    console.error(error);
                }
            });
        });

        
    });
</script>

<style>
    .custom-width-input {
        max-width: 300px;
        margin-left: 500px;
    }
</style>
{{>footer}}
