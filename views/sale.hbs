{{>header}}



<div class="container">
    <h1>Facturación</h1>
    <form id="sale-form" action="/sales" method="POST">
        <div class="form-group row">
            <label for="factura" class="col-sm-2 col-form-label">Factura</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="factura" name="factura" value="0" readonly>
            </div>
            <label for="vendedor" class="col-sm-2 col-form-label">Vendedor</label>
            <div class="col-sm-4">
                <select class="form-control" id="vendedor" name="vendedor" required>
                    {{#each users}}
                    <option value="{{this.username}}">{{this.username}}</option>
                    {{/each}}
                </select>
            </div>
        </div>

        <div class="form-group row">
            <label for="pago" class="col-sm-2 col-form-label">Pago</label>
            <div class="col-sm-4">
                <select class="form-control" id="pago" name="pago" required>
                    <option value="Efectivo">Efectivo</option>
                    <option value="Mercado Pago">Mercado Pago</option>
                </select>
            </div>

            <label for="fecha" class="col-sm-2 col-form-label">Fecha</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="fecha" name="fecha" value="{{currentDate}}" readonly>
            </div>
        </div>

        <div class="form-group row">
            <label for="cod_barra" class="col-sm-2 col-form-label">Código de Barras</label>
            <div class="col-sm-4">
                <input type="number" class="form-control" id="cod_barra" name="cod_barra" required>
            </div>
            <div class="col-md-6">
                <button type="button" onclick="buscarProducto()" class="btn btn-primary mt-2">Buscar</button>
            </div>
        </div>
    </form>

    <table class="table">
        <thead>
            <tr>
                <th>Cant</th>
                <th>Código de Barras</th>
                <th>Descripción</th>
                <th>Precio</th>
                <th>Total</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="productosEncontrados">
            <!-- Aquí se agregarán dinámicamente los productos -->
        </tbody>
    </table>
</div>

<!-- Modal para seleccionar productos -->
<div class="modal fade" id="productModal" tabindex="-1" role="dialog" aria-labelledby="productModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">Seleccionar Producto</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Código de Barras</th>
                            <th>Descripción</th>
                            <th>Precio</th>
                            <th>Seleccionar</th>
                        </tr>
                    </thead>
                    <tbody id="productList">
                        <!-- Aquí se agregarán los productos disponibles -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>





<script>
    document.addEventListener('DOMContentLoaded', () => {
        const fechaInput = document.getElementById('fecha');
        fechaInput.value = new Date().toISOString().split('T')[0];

        fetch('/users')
            .then(response => response.json())
            .then(users => {
                const vendedorSelect = document.getElementById('vendedor');
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = user.username;
                    vendedorSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error al cargar los usuarios:', error));
    });

    function buscarProducto() {
        const codigo = document.getElementById('cod_barra').value;
        fetch('/sales/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codigo })
        })
            .then(response => response.json())
            .then(product => {
                if (product.message) {
                    alert(product.message);
                } else {
                    const tbody = document.getElementById('productosEncontrados');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>1</td>
                        <td>${product.cod_barra}</td>
                        <td>${product.descripcion}</td>
                        <td>${product.precio}</td>
                        <td>${product.precio}</td>
                        <td><button type="button" onclick="borrarArticulo(this)" class="btn btn-danger">Borrar</button></td>
                    `;
                    tbody.appendChild(row);
                }
            })
            .catch(error => console.error('Error al buscar el producto:', error));
    }

    function borrarArticulo(button) {
        const row = button.closest('tr');
        row.remove();
    }
</script>



{{>footer}}