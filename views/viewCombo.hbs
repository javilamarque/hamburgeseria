{{>header}}



<div class="container">
    <h1 class="mt-5 text-center">Crear Combo</h1>

    <div class="mt-3">
        <input type="text" id="nombre-combo" class="form-control mx-auto" style="max-width: 300px;"
            placeholder="INGRESE NOMBRE DEL COMBO" required>
    </div>

    <div id="items-section" class="mt-3 text-center">
        <!-- Contenedor dinámico para productos -->
        <div id="productos-container"></div>
        <button type="button" id="agregar-producto-btn" class="btn btn-secondary mt-2">Agregar Producto</button>
    </div>

    <div id="precio-section" class="mt-3 text-center">
        <div class="row justify-content-center">
            <div class="col-md-4 mb-2">
                <input type="text" id="codigo-barra" class="form-control" placeholder="Código de Barra" required>
            </div>
            <div class="col-md-4">
                <input type="number" id="precio-combo" class="form-control" placeholder="Precio del Combo" required>
            </div>
        </div>
    </div>

    <div class="mt-4 mb-3 text-center">
        <button id="cancelar-btn" class="btn btn-danger">Cancelar</button>
        <button id="agregar-items-btn" class="btn btn-primary ms-2">Agregar Items</button>
        <button id="guardar-btn" class="btn btn-success ms-2">Guardar</button>
    </div>
</div>

<!-- Modal para seleccionar productos -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">Seleccionar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Código de Barras</th>
                            <th>Descripción</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Seleccionar</th>
                        </tr>
                    </thead>
                    <tbody id="productList">
                        <!-- Aquí se cargarán los productos -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.3/js/bootstrap.min.js"></script>

<script>
    $(document).ready(function () {
        // Mostrar secciones de items y precio al hacer clic en "Agregar Items"
        $('#agregar-items-btn').click(function () {
            $('#items-section').removeClass('d-none');
            $('#precio-section').removeClass('d-none');
        });

        // Funcionalidad del botón "Cancelar"
        $('#cancelar-btn').click(function () {
            window.location.href = '/home';
        });

        // Añadir nuevo campo de producto
        $('#agregar-producto-btn').click(function () {
            const productoRow = `
                <div class="row justify-content-center align-items-center mt-2">
                        <div class="col-md-6">
                            <input type="text" class="form-control mb-2 producto-seleccionado" placeholder="Seleccione un producto" readonly>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-primary seleccionar-producto-btn mb-2 w-100">Seleccionar Producto</button>
                        </div>
                    </div>
            `;
            $('#productos-container').append(productoRow);
        });

        // Abrir el modal de selección de producto al hacer clic en el botón "Seleccionar Producto"
        $(document).on('click', '.seleccionar-producto-btn', function () {
            const productoInput = $(this).closest('.row').find('.producto-seleccionado');

            $.get('/sales/products', function (products) {
                $('#productList').empty();
                products.forEach(function (product) {
                    let row = `
                        <tr>
                            <td>${product.cod_barra}</td>
                            <td>${product.descripcion}</td>
                            <td>${product.precio_venta}</td>
                            <td>${product.stock}</td>
                            <td>
                                <button type="button" class="btn btn-primary seleccionar-producto" 
                                    data-cod_barra="${product.cod_barra}" 
                                    data-descripcion="${product.descripcion}" 
                                    data-precio="${product.precio_venta}">
                                    Seleccionar
                                </button>
                            </td>
                        </tr>
                    `;
                    $('#productList').append(row);
                });
                $('#productModal').modal('show');

                // Seleccionar un producto del modal
                $(document).off('click', '.seleccionar-producto').on('click', '.seleccionar-producto', function () {
                    let descripcion = $(this).data('cod_barra');
                    productoInput.val(descripcion);
                    $('#productModal').modal('hide');
                });
            }).fail(function () {
                alert('Error al cargar los productos');
            });
        });

        // Validar y guardar el combo
        $('#guardar-btn').click(function () {
            const nombreCombo = $('#nombre-combo').val();
            const codigoBarra = $('#codigo-barra').val();
            const precioCombo = $('#precio-combo').val();
            const productos = [];

            $('.producto-seleccionado').each(function () {
                if ($(this).val() !== '') {
                    productos.push($(this).val());
                }
            });

            if (!nombreCombo || !codigoBarra || !precioCombo || productos.length === 0) {
                alert('Por favor complete todos los campos.');
                return;
            }

            const comboData = {
                nombre: nombreCombo,
                codigoBarra: codigoBarra,
                precio: precioCombo,
                productos: productos
            };

            $.ajax({
                type: 'POST',
                url: '/combos',
                data: JSON.stringify(comboData),
                contentType: 'application/json',
                success: function (response) {
                    alert('Combo guardado exitosamente');
                    window.location.href = '/home';
                },
                error: function (error) {
                    alert('Error al guardar el combo');
                    console.error(error);
                }
            });
        });
    });
</script>

<style>
    .custom-width-input {
        max-width: 300px;
        /* Ajusta el valor según necesites */
        margin-left: 500px;
    }
</style>

{{>footer}}